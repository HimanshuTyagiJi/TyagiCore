<!DOCTYPE html>
<html lang="{% if page.lang == 'hi' %}hi{% else %}en{% endif %}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% if page.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
<meta name="description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
<meta name="author" content="{{ site.author }}">
<meta name="robots" content="index, follow">
<link rel="canonical" href="{{ page.url | absolute_url }}">

<meta property="og:type"        content="{% if page.is_post %}article{% else %}website{% endif %}">
<meta property="og:title"       content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
<meta property="og:description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
<meta property="og:url"         content="{{ page.url | absolute_url }}">
<meta property="og:site_name"   content="{{ site.title }}">
{% if page.image %}
<meta property="og:image"        content="{{ page.image | absolute_url }}">
<meta name="twitter:card"        content="summary_large_image">
<meta name="twitter:image"       content="{{ page.image | absolute_url }}">
{% else %}
<meta name="twitter:card"        content="summary">
{% endif %}
<meta name="twitter:title"       content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
<meta name="twitter:description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">

{% seo %}

<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
<link rel="stylesheet" href="{{ '/assets/css/style.css' | absolute_url }}">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"{% if page.is_post %}Article{% else %}WebSite{% endif %}",
  "name":"{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}",
  "description":"{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}",
  "url":"{{ page.url | absolute_url }}",
  "publisher":{"@type":"Organization","name":"{{ site.title }}","url":"{{ site.url }}"}
}
</script>
</head>
<body>

<!-- HEADER -->
<header class="tc-header-bar" role="banner">
  <div class="header-inner">
    <a href="{{ '/' | absolute_url }}" class="logo" aria-label="{{ site.title }} Home">
      <svg width="152" height="36" viewBox="0 0 480 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#1a73e8"/>
            <stop offset="50%"  stop-color="#ea4335"/>
            <stop offset="100%" stop-color="#f97316"/>
          </linearGradient>
        </defs>
        <text x="8" y="52" font-size="62" font-weight="900" font-family="Georgia,serif"
          fill="none" stroke="url(#lg1)" stroke-width="2.2"
          stroke-dasharray="750" stroke-dashoffset="750">
          Tyagi
          <animate attributeName="stroke-dashoffset" values="750;0" dur="1.8s" fill="freeze"/>
        </text>
        <text x="8" y="106" font-size="48" font-weight="900" font-family="Georgia,serif"
          fill="none" stroke="url(#lg1)" stroke-width="2">
          CORE
          <animate attributeName="stroke-width" values="2;2.8;2" dur="3s" repeatCount="indefinite"/>
        </text>
      </svg>
    </a>

    <nav class="nav" role="navigation" aria-label="Main navigation">
      <a href="{{ '/' | absolute_url }}">Home</a>
      <a href="{{ '/about' | absolute_url }}">About</a>
      <a href="{{ '/privacy' | absolute_url }}">Privacy</a>
      <a href="{{ '/terms' | absolute_url }}">Terms</a>
      <span style="display:none" aria-hidden="true">
        <a href="{{ '/networking' | absolute_url }}">Networking</a>
        <a href="{{ '/cyber' | absolute_url }}">Cyber</a>
        <a href="{{ '/ai' | absolute_url }}">AI</a>
        <a href="{{ '/linux' | absolute_url }}">Linux</a>
        <a href="{{ '/cloud' | absolute_url }}">Cloud</a>
      </span>
    </nav>

    <div class="right-icons">
      <button class="icon-btn" onclick="toggleSearch(true)" aria-label="Search articles">
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
      </button>
      <button class="icon-btn hamburger" onclick="toggleMenu(true)" aria-label="Open menu" aria-expanded="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
    </div>
  </div>
</header>

<div id="reading-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Reading progress">
  <div id="reading-progress-bar"></div>
</div>

<!-- SEARCH -->
<div id="searchModal" role="dialog" aria-modal="true" aria-label="Search" onclick="closeOnOverlay(event)" style="display:none">
  <div class="search-box">
    <div class="search-input-area">
      <label for="searchInput" class="sr-only">Search</label>
      <input type="search" id="searchInput" placeholder="Search articles..." onkeyup="globalSearch()" autocomplete="off">
      <button class="close-modal" onclick="toggleSearch(false)" aria-label="Close">‚úï</button>
    </div>
    <div id="searchResults" role="listbox">
      <p style="text-align:center;padding:20px;color:#94a3b8;">Start typing...</p>
    </div>
  </div>
</div>

<!-- MOBILE MENU -->
<div class="mobile-overlay" onclick="toggleMenu(false)" aria-hidden="true"></div>
<nav class="mobile-menu" role="navigation" aria-label="Mobile navigation">
  <div class="mobile-header">
    <span style="font-weight:900;font-size:18px;background:linear-gradient(135deg,#1a73e8,#ea4335,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">TYAGI CORE</span>
    <button onclick="toggleMenu(false)" aria-label="Close menu" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--text-color)">‚úï</button>
  </div>
  <div class="mobile-nav">
    <a href="{{ '/' | absolute_url }}">üè† Home</a>
    <a href="{{ '/about' | absolute_url }}">üë§ About</a>
    <a href="{{ '/privacy' | absolute_url }}">üîí Privacy</a>
    <a href="{{ '/terms' | absolute_url }}">üìÑ Terms</a>
    <span style="display:none" aria-hidden="true">
      <a href="{{ '/networking' | absolute_url }}">Networking</a>
      <a href="{{ '/cyber' | absolute_url }}">Cyber</a>
      <a href="{{ '/ai' | absolute_url }}">AI</a>
      <a href="{{ '/linux' | absolute_url }}">Linux</a>
    </span>
  </div>
</nav>

{% if page.url == "/" or page.url == "/index.html" %}
<section class="tc-hero" aria-label="Welcome">
  <div class="hero-content">
    <span class="hero-badge">üöÄ Tech ¬∑ Security ¬∑ AI ¬∑ Linux</span>
    <h1>Build Real Tech From Scratch</h1>
    <p>Practical guides & projects to master the digital world</p>
    <div class="hero-btns">
      <a href="#posts" class="btn btn-primary">Learn Now</a>
      <a href="{{ '/about' | absolute_url }}" class="btn btn-outline">About Us</a>
    </div>
  </div>
</section>
{% endif %}

<div id="index-category-nav"></div>

<main class="tc-wrapper" id="main-content">
  <div class="tc-left">
    {% unless page.url == "/" or page.url == "/index.html" %}
    <div class="toc-container" id="toc-box" style="display:none;" aria-label="Table of contents">
      <div class="toc-title"><i class="fas fa-list-ul" aria-hidden="true"></i>&nbsp; Topics</div>
      <ul id="toc-list" role="list"></ul>
      <button id="toc-toggle-btn" class="toc-see-more" aria-expanded="false">
        See More <i class="fas fa-chevron-down" aria-hidden="true"></i>
      </button>
    </div>
    {% endunless %}

    {{ content }}

    {% unless page.url == "/" or page.url == "/index.html" %}
    <div class="share-wrapper">
      <p class="share-label">Share With Friends</p>
      <button onclick="tyagiShare()" class="tyagi-share-btn" aria-label="Share this article">
        <i class="fas fa-paper-plane" aria-hidden="true"></i> SHARE ARTICLE
      </button>
    </div>

    <!-- PREVIOUS / NEXT ‚Äî Only show if the post exists -->
    <nav class="post-nav-container" aria-label="Post navigation">
      <div class="post-nav-link prev">
        {% if page.previous and page.previous.is_post %}
        <a href="{{ page.previous.url | relative_url }}">
          <span class="nav-label"><i class="fas fa-arrow-left" aria-hidden="true"></i> Previous</span>
          <div class="nav-post-title">{{ page.previous.title }}</div>
        </a>
        {% endif %}
      </div>
      <div class="post-nav-link next">
        {% if page.next and page.next.is_post %}
        <a href="{{ page.next.url | relative_url }}">
          <span class="nav-label">Next <i class="fas fa-arrow-right" aria-hidden="true"></i></span>
          <div class="nav-post-title">{{ page.next.title }}</div>
        </a>
        {% endif %}
      </div>
    </nav>

    <hr style="margin:44px 0;border:none;border-top:1px solid var(--border-color)">
    {% endunless %}
  </div>

  <!-- SIDEBAR -->
  <aside class="tc-sidebar" aria-label="Sidebar">
    <div class="box">üî• Trending Now</div>
    <div id="trending-sidebar-items"></div>

    <div class="box" style="margin-top:18px;">üì° Follow Us</div>
    <div class="tyagi-social-hub">
      <a class="hub-card yt-main"    href="https://youtube.com/@tyagicore"    target="_blank" rel="noopener noreferrer" aria-label="YouTube TyagiCore">
        <div class="hub-icon"><i class="fab fa-youtube" aria-hidden="true"></i></div>
        <div class="hub-info"><span class="hub-name">TyagiCore</span><span class="hub-desc">Tech & Systems</span></div>
        <div class="hub-action">Join</div>
      </a>
      <a class="hub-card study-card" href="https://youtube.com/@gklearnstudy" target="_blank" rel="noopener noreferrer" aria-label="YouTube GK Learn">
        <div class="hub-icon"><i class="fas fa-graduation-cap" aria-hidden="true"></i></div>
        <div class="hub-info"><span class="hub-name">GK Learn Study</span><span class="hub-desc">Education</span></div>
        <div class="hub-action">Join</div>
      </a>
      <a class="hub-card ig-card"    href="https://instagram.com/tyagicore"   target="_blank" rel="noopener noreferrer" aria-label="Instagram">
        <div class="hub-icon"><i class="fab fa-instagram" aria-hidden="true"></i></div>
        <div class="hub-info"><span class="hub-name">Instagram</span><span class="hub-desc">Daily Updates</span></div>
        <div class="hub-action">Follow</div>
      </a>
      <a class="hub-card fb-card"    href="https://facebook.com/himanshutyagie" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
        <div class="hub-icon"><i class="fab fa-facebook-f" aria-hidden="true"></i></div>
        <div class="hub-info"><span class="hub-name">Facebook</span><span class="hub-desc">Community</span></div>
        <div class="hub-action">Like</div>
      </a>
      <a class="hub-card tg-card"    href="https://t.me/TyagiCore"            target="_blank" rel="noopener noreferrer" aria-label="Telegram">
        <div class="hub-icon"><i class="fab fa-telegram-plane" aria-hidden="true"></i></div>
        <div class="hub-info"><span class="hub-name">Telegram</span><span class="hub-desc">Files & Updates</span></div>
        <div class="hub-action">Join</div>
      </a>
    </div>

    <div class="box" style="margin-top:18px;">üì± Our Apps</div>
    <div class="tyagi-app-container">
      <div class="app-card">
        <div class="app-logo-box" style="background:#1a73e8">TC</div>
        <div class="app-details"><span class="app-name">TyagiCore</span><span class="app-meta">v1.1</span></div>
        <span class="download-btn">Coming Soon</span>
      </div>
      <div class="app-card">
        <div class="app-logo-box" style="background:#ea4335">GK</div>
        <div class="app-details"><span class="app-name">GK Learn Quiz</span><span class="app-meta">v2.0</span></div>
        <span class="download-btn">Coming Soon</span>
      </div>
    </div>
  </aside>
</main>

{% if page.url == "/" or page.url == "/index.html" %}
<section class="tc-bottom-section" aria-label="About Tyagi Core">
  <div class="tc-ultra-final">
    <div class="bg-mesh" aria-hidden="true"></div>
    <div class="section-header">
      <span class="badge">Tyagi Core Framework</span>
      <h2>Architecting The Future of Digital Systems</h2>
      <p class="subtext">A structured knowledge engine focused on how modern digital infrastructure truly operates at its foundational level.</p>
    </div>
    <div class="tc-grid">
      <div class="tc-feat-card">
        <div class="feat-icon" aria-hidden="true">
          <svg viewBox="0 0 100 100" width="58" height="58">
            <circle cx="50" cy="50" r="38" fill="none" stroke="#1a73e8" stroke-width="1.5" stroke-dasharray="380" stroke-dashoffset="380"><animate attributeName="stroke-dashoffset" values="380;0" dur="2s" fill="freeze"/></circle>
            <circle cx="50" cy="50" r="16" fill="none" stroke="#1a73e8" stroke-width="1.5" stroke-dasharray="100" stroke-dashoffset="100"><animate attributeName="stroke-dashoffset" values="100;0" dur="2s" begin="0.4s" fill="freeze"/></circle>
          </svg>
        </div>
        <h3>Deep System Architecture</h3>
        <p>TCP/IP routing, kernel models, memory allocation ‚Äî we analyze how every layer interacts and how data travels in real time.</p>
      </div>
      <div class="tc-feat-card">
        <div class="feat-icon" aria-hidden="true">
          <svg viewBox="0 0 100 100" width="58" height="58">
            <path d="M50 10 L85 25 V55 C85 75 70 90 50 95 C30 90 15 75 15 55 V25 Z" fill="none" stroke="#ea4335" stroke-width="1.5" stroke-dasharray="480" stroke-dashoffset="480"><animate attributeName="stroke-dashoffset" values="480;0" dur="2s" fill="freeze"/></path>
          </svg>
        </div>
        <h3>Cyber Defense & Privacy</h3>
        <p>Firewall architecture, encryption layers, zero-trust systems ‚Äî security is architecture-based, not fear-based.</p>
      </div>
      <div class="tc-feat-card">
        <div class="feat-icon" aria-hidden="true">
          <svg viewBox="0 0 100 100" width="58" height="58">
            <circle cx="20" cy="50" r="8" fill="none" stroke="#f97316" stroke-width="1.5"/>
            <circle cx="80" cy="50" r="8" fill="none" stroke="#f97316" stroke-width="1.5"/>
            <circle cx="50" cy="20" r="8" fill="none" stroke="#f97316" stroke-width="1.5"/>
            <circle cx="50" cy="80" r="8" fill="none" stroke="#f97316" stroke-width="1.5"/>
            <line x1="28" y1="50" x2="42" y2="50" stroke="#f97316" stroke-width="1.5"/>
            <line x1="58" y1="50" x2="72" y2="50" stroke="#f97316" stroke-width="1.5"/>
            <line x1="50" y1="28" x2="50" y2="42" stroke="#f97316" stroke-width="1.5"/>
            <line x1="50" y1="58" x2="50" y2="72" stroke="#f97316" stroke-width="1.5"/>
          </svg>
        </div>
        <h3>Distributed Networks</h3>
        <p>CDN logic, load balancing, latency optimization ‚Äî engineer performance, not guess it.</p>
      </div>
    </div>
  </div>
</section>
{% endif %}

<button id="dark-mode-toggle" class="theme-wheel" aria-label="Toggle dark/light mode">
  <div class="wheel-icon-wrap">
    <i class="fas fa-moon moon-icon" aria-hidden="true"></i>
    <i class="fas fa-sun sun-icon"  aria-hidden="true"></i>
  </div>
</button>

{% if page.is_post %}
<!-- COMMENTS -->
<div id="tc-root" role="region" aria-label="Comments and ratings">
  <div class="tc-comments-header">
    <div class="tc-header-left">
      <h2 style="margin:0;font-size:17px;">Discussion &amp; Reviews</h2>
      <div id="tc-rating-summary" class="tc-ps-rating">
        <span id="tc-avg-num" class="tc-avg-big">0.0</span>
        <div class="tc-ps-stars-wrap">
          <div id="tc-avg-stars" class="tc-stars-fs" aria-label="Average rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <div id="tc-total-votes" class="tc-total-v">0 reviews</div>
        </div>
      </div>
    </div>
    <div id="tc-auth-zone">
      <div id="tc-auth-gate">
        <div id="g_id_onload"
          data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com"
          data-callback="onGoogleAuth"></div>
        <div class="g_id_signin" data-type="standard" data-shape="pill"></div>
      </div>
      <div id="tc-user-pill" style="display:none" class="tc-user-pill">
        <img id="tc-user-pfp" src="" class="tc-pfp-small" alt="Your profile picture">
        <span id="tc-user-name" class="tc-u-name"></span>
        <button onclick="tcLogout()" class="tc-logout-btn" aria-label="Logout">Logout</button>
      </div>
    </div>
  </div>

  <div class="tc-user-rate-box">
    <p style="margin:0 0 5px;font-size:12px;color:var(--text-muted)">Rate this article:</p>
    <div id="tc-star-row" class="tc-stars-input" role="group" aria-label="Star rating">
      <span class="tc-s" onclick="handleStar(1)" onmouseover="hoverStar(1)" onmouseout="resetStar()" role="button" tabindex="0" aria-label="1 star">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(2)" onmouseover="hoverStar(2)" onmouseout="resetStar()" role="button" tabindex="0" aria-label="2 stars">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(3)" onmouseover="hoverStar(3)" onmouseout="resetStar()" role="button" tabindex="0" aria-label="3 stars">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(4)" onmouseover="hoverStar(4)" onmouseout="resetStar()" role="button" tabindex="0" aria-label="4 stars">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(5)" onmouseover="hoverStar(5)" onmouseout="resetStar()" role="button" tabindex="0" aria-label="5 stars">‚òÖ</span>
    </div>
  </div>

  <div id="tc-main-editor" class="tc-editor-box">
    <label for="tc-input" class="sr-only">Write a comment</label>
    <textarea id="tc-input" placeholder="Join the discussion..."></textarea>
    <div style="text-align:right;margin-top:8px;">
      <button onclick="handleAction('0')" class="tc-post-btn">Post Comment</button>
    </div>
  </div>
  <div id="tc-feed" class="tc-feed" role="list"></div>
</div>
{% endif %}

<!-- FOOTER -->
<footer class="tc-footer" role="contentinfo">
  <div class="footer-grid">
    <div>
      <h3>About Tyagi Core</h3>
      <p>Innovation and education without limits. Deep tech insights for everyone.</p>
    </div>
    <div>
      <h4>Pages</h4>
      <a href="{{ '/about'   | absolute_url }}">About</a>
      <a href="{{ '/privacy' | absolute_url }}">Privacy Policy</a>
      <a href="{{ '/terms'   | absolute_url }}">Terms of Service</a>
    </div>
    <div>
      <h4>Categories</h4>
      <p>Cyber Security</p>
      <p>Networking</p>
      <p>AI & Linux</p>
    </div>
    <div>
      <h4>Social</h4>
      <a href="https://t.me/TyagiCore"            target="_blank" rel="noopener noreferrer">Telegram</a>
      <a href="https://youtube.com/@tyagicore"    target="_blank" rel="noopener noreferrer">YouTube</a>
      <a href="https://instagram.com/tyagicore"   target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="https://facebook.com/himanshutyagie" target="_blank" rel="noopener noreferrer">Facebook</a>
    </div>
  </div>
  <div class="footer-bottom">
    <p>¬© {{ site.time | date: "%Y" }} {{ site.title }}. All rights reserved.</p>
  </div>
</footer>

<button id="tyagi-top-wrap" aria-label="Scroll to top">
  <svg class="tyagi-progress-svg" viewBox="-1 -1 102 102" aria-hidden="true">
    <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
  </svg>
  <i class="fas fa-arrow-up top-arrow-icon" aria-hidden="true"></i>
</button>

<!-- Posts data ‚Äî image: per post se aayegi, agar nahi toh "" rahega -->
<script>
window.tyagiPosts = [
  {% assign all_posts = site.pages | where: "is_post", true %}
  {% for p in all_posts %}
  {
    "title":  {{ p.title | jsonify }},
    "url":    {{ p.url | relative_url | jsonify }},
    "image":  {{ p.image | default: "" | jsonify }},
    "excerpt":{{ p.description | default: "" | strip_html | truncate: 120 | jsonify }}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];
</script>

<script src="{{ '/assets/js/main.js' | absolute_url }}" defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

{% if page.is_post %}
<script type="module">
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbympst5_Jwnf_IMo6aiSe0pxryLrrmdDY6ZfH7uf5Km69lZNTDD2OwqWGzstzKVPQvw/exec";
let user = JSON.parse(localStorage.getItem("tc_user")) || null;
let serverData = [], tempLocal = [], isTyping = false, currentRating = 0;

function init(){
  if(user){
    document.getElementById("tc-auth-gate").style.display  = "none";
    document.getElementById("tc-user-pill").style.display  = "flex";
    document.getElementById("tc-user-name").innerText      = user.n;
    document.getElementById("tc-user-pfp").src             = user.p;
  }
  sync();
  setInterval(()=>{ if(!isTyping) sync(); }, 5000);
}
window.onGoogleAuth = r => {
  const p = JSON.parse(atob(r.credential.split(".")[1]));
  user = {n:p.name, e:p.email, p:p.picture};
  localStorage.setItem("tc_user", JSON.stringify(user));
  location.reload();
};
window.tcLogout = ()=>{ localStorage.removeItem("tc_user"); location.reload(); };
window.hoverStar = n =>{ if(!isTyping && currentRating===0) paintStars(n); };
window.resetStar  = ()=> paintStars(currentRating);
window.handleStar = n =>{
  if(!user) return alert("Login required to rate!");
  currentRating=n; paintStars(n);
  fetch(SCRIPT_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({url:location.pathname,email:user.e,rating:n,comment:"__RATING_ONLY__"})});
};
function paintStars(n){
  document.querySelectorAll(".tc-s").forEach((s,i)=>s.classList.toggle("active",i<n));
}
window.handleAction = (pid, mode, rowId) => {
  mode=mode||"new"; rowId=rowId||null;
  if(!user) return alert("Please login first!");
  const inId = mode==="edit" ? "edit-in-"+rowId : (pid==="0" ? "tc-input" : "reply-in-"+pid);
  const inEl = document.getElementById(inId);
  const msg  = inEl?.value.trim();
  if(!msg) return;
  if(mode==="new"){
    tempLocal.push({rowId:"tmp_"+Date.now(),name:user.n,comment:msg,parentId:pid,pic:user.p,date:"Saving‚Ä¶",pending:true,isAdmin:false,email:user.e});
  } else {
    const t = serverData.find(c=>c.rowId==rowId);
    if(t){t.comment=msg; t.date="Updating‚Ä¶";}
  }
  render(); if(inEl) inEl.value=""; isTyping=false;
  const payload={url:location.pathname,name:user.n,email:user.e,pic:user.p,comment:msg,parentId:pid,rating:currentRating};
  if(mode==="edit"){payload.action="edit";payload.rowId=rowId;}
  fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(payload),mode:"no-cors"});
  setTimeout(sync,1500);
};
async function sync(){
  try{
    const ep = user ? "&email="+encodeURIComponent(user.e) : "";
    const r  = await fetch(SCRIPT_URL+"?url="+location.pathname+ep);
    const d  = await r.json();
    serverData=d.comments; tempLocal=[];
    if(user && d.myRating>0) currentRating=d.myRating;
    updateRating(d.avgRating, d.totalVotes);
    paintStars(currentRating); render();
  }catch(e){}
}
function updateRating(avg,total){
  document.getElementById("tc-avg-num").innerText     = avg;
  document.getElementById("tc-total-votes").innerText = total+" reviews";
  let s="", r=Math.round(parseFloat(avg));
  for(let i=1;i<=5;i++) s+=i<=r?"‚òÖ":"‚òÜ";
  document.getElementById("tc-avg-stars").innerText=s;
}
function render(){
  const feed = document.getElementById("tc-feed");
  const all  = serverData.concat(tempLocal);
  const tops = all.filter(c=>c.parentId=="0").reverse();
  feed.innerHTML = tops.map(c=>card(c,all)).join("");
}
function card(c, list){
  const me = user && user.e===c.email;
  const stars = c.userRating>0 ? `<span style="color:var(--yellow);font-size:11px;margin-left:6px;">${"‚òÖ".repeat(c.userRating)}</span>` : "";
  let h=`<div class="tc-card ${c.parentId!="0"?"reply ":""}${c.pending?"pending":""}" role="listitem">
    <div class="tc-card-meta">
      <img src="${c.pic}" class="tc-card-pfp" alt="${c.name}" loading="lazy">
      <span class="tc-card-name">${c.name}</span>
      ${c.isAdmin?'<span class="tc-admin-badge">ADMIN ‚≠ê</span>':""}
      ${stars}
      <span class="tc-card-time">${c.date}</span>
    </div>
    <div class="tc-card-body" id="body-${c.rowId}">${c.comment}</div>
    <div class="tc-actions">
      <button onclick="openBox('${c.rowId}','reply')">Reply</button>
      ${me?`<button onclick="openBox('${c.rowId}','edit')">Edit</button>`:""}
      ${me?`<button style="color:var(--red)" onclick="delMsg('${c.rowId}')">Delete</button>`:""}
    </div>
    <div id="box-${c.rowId}" class="tc-inline-box"></div></div>`;
  list.filter(r=>r.parentId==c.rowId).forEach(r=>{h+=card(r,list);});
  return h;
}
window.openBox = (id,type)=>{
  if(!user) return alert("Login to interact!");
  isTyping=true;
  document.querySelectorAll(".tc-inline-box").forEach(b=>b.innerHTML="");
  const box=document.getElementById("box-"+id);
  if(type==="reply"){
    box.innerHTML=`<textarea id="reply-in-${id}" placeholder="Write a reply..."></textarea>
      <div style="text-align:right;margin-top:5px;">
        <button onclick="isTyping=false;this.parentElement.parentElement.innerHTML=''" style="background:none;border:none;cursor:pointer;font-size:12px;margin-right:8px;color:var(--text-muted)">Cancel</button>
        <button class="tc-post-btn" onclick="handleAction('${id}')">Reply</button></div>`;
  } else {
    const old=document.getElementById("body-"+id)?.innerText||"";
    box.innerHTML=`<textarea id="edit-in-${id}">${old}</textarea>
      <div style="text-align:right;margin-top:5px;">
        <button onclick="isTyping=false;this.parentElement.parentElement.innerHTML=''" style="background:none;border:none;cursor:pointer;font-size:12px;margin-right:8px;color:var(--text-muted)">Cancel</button>
        <button class="tc-post-btn" onclick="handleAction('0','edit','${id}')">Update</button></div>`;
  }
  box.querySelector("textarea")?.focus();
};
// legacy alias
window.checkAuthAndOpen = window.openBox;
window.delMsg = async id=>{
  if(!confirm("Delete permanently?")) return;
  await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"delete",rowId:id,userEmail:user.e}),mode:"no-cors"});
  sync();
};
init();
</script>
{% endif %}

</body>
</html>
