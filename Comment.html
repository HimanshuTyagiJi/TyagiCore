<script type="application/ld+json" id="tc-seo-schema"></script>

<div id="tc-root">
  <div class="tc-main-header">
    <div class="tc-branding">
      <h2 class="tc-title">Community Reviews</h2>
      <div id="tc-avg-display" class="tc-avg">‚≠ê Loading...</div>
    </div>
    <div class="tc-privacy-badge">üîí Privacy Protected</div>
  </div>

  <div class="tc-rating-card">
    <div id="tc-star-row" class="tc-stars">
      <span class="tc-s" onclick="handleStar(1)" onmouseover="hoverStar(1)" onmouseout="resetStar()">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(2)" onmouseover="hoverStar(2)" onmouseout="resetStar()">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(3)" onmouseover="hoverStar(3)" onmouseout="resetStar()">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(4)" onmouseover="hoverStar(4)" onmouseout="resetStar()">‚òÖ</span>
      <span class="tc-s" onclick="handleStar(5)" onmouseover="hoverStar(5)" onmouseout="resetStar()">‚òÖ</span>
    </div>
    <p id="tc-rate-msg" class="tc-rate-msg"></p>
  </div>

  <div id="tc-auth-gate" class="tc-auth-gate">
    <div id="g_id_onload" data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com" data-callback="onGoogleAuth"></div>
    <div class="g_id_signin" data-type="standard" data-shape="pill"></div>
  </div>

  <div id="tc-main-editor" class="tc-editor" style="display:none">
    <div class="tc-u-info">
      <img id="tc-user-pfp" src="" class="tc-pfp">
      <span id="tc-user-name" class="tc-name"></span>
      <button onclick="tcLogout()" class="tc-logout">Sign Out</button>
    </div>
    <textarea id="tc-input" placeholder="Join the discussion..."></textarea>
    <button onclick="submitComment('0')" class="tc-post-btn">Post Comment</button>
  </div>

  <div class="tc-feed-head"><span id="tc-count">0</span> Comments</div>
  <div id="tc-feed" class="tc-feed">
    <div class="tc-loader">Syncing...</div>
  </div>
</div>

<style>
#tc-root { max-width: 800px; margin: 20px auto; background: #fff; border: 1px solid #ddd; border-radius: 12px; font-family: sans-serif; color: #333; overflow: hidden; }
.tc-main-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.tc-avg { color: #f4b400; font-weight: bold; margin-top: 5px; }
.tc-privacy-badge { font-size: 11px; color: #1e8e3e; background: #e6f4ea; padding: 4px 10px; border-radius: 20px; }
.tc-rating-card { padding: 15px; text-align: center; background: #fafafa; border-bottom: 1px solid #eee; }
.tc-stars { font-size: 30px; color: #ddd; cursor: pointer; }
.tc-s.active { color: #f4b400; }
.tc-auth-gate { padding: 30px; text-align: center; }
.tc-editor { padding: 20px; border-bottom: 1px solid #eee; }
.tc-u-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.tc-pfp { width: 35px; height: 35px; border-radius: 50%; }
.tc-logout { font-size: 11px; border: none; background: none; color: #d93025; cursor: pointer; }
textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; resize: none; outline: none; margin-bottom: 10px; box-sizing: border-box;}
.tc-post-btn { background: #1a73e8; color: #fff; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

.tc-card { padding: 15px 20px; border-bottom: 1px solid #f5f5f5; }
.tc-card.reply { margin-left: 45px; border-left: 2px solid #eee; background: #fafafa; }
.tc-meta { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
.tc-body { margin: 8px 0 8px 43px; font-size: 14px; line-height: 1.5; }
.tc-actions { margin-left: 43px; display: flex; gap: 15px; font-size: 12px; color: #666; font-weight: bold; }
.tc-btn { cursor: pointer; }
.tc-btn:hover { color: #1a73e8; }
.tc-del { color: #d93025; }
.tc-inline-editor { margin: 10px 0 10px 43px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
</style>

<script>
(function() {
  // NEW SCRIPT URL APPLIED
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnb3XRauRWpX6K8p--dPwmYZ3_Tpy_705mE6ojp68USXrYfydAlWtjluGDqqJ88ZcP/exec";
  
  let user = JSON.parse(localStorage.getItem("tc_user")) || null;
  let rating = 0;
  let lastDataCount = 0;

  function init() {
    if(user) showEditor();
    const saved = localStorage.getItem("tc_rate_" + location.pathname);
    if(saved) { rating = parseInt(saved); paintStars(rating); }
    if("Notification" in window) Notification.requestPermission();
    sync();
    setInterval(sync, 3000);
  }

  window.onGoogleAuth = (res) => {
    const p = JSON.parse(atob(res.credential.split('.')[1]));
    user = { n: p.name, e: p.email, p: p.picture };
    localStorage.setItem("tc_user", JSON.stringify(user));
    location.reload();
  };

  function showEditor() {
    document.getElementById("tc-auth-gate").style.display = "none";
    document.getElementById("tc-main-editor").style.display = "block";
    document.getElementById("tc-user-name").innerText = user.n;
    document.getElementById("tc-user-pfp").src = user.p;
  }

  window.tcLogout = () => { localStorage.removeItem("tc_user"); location.reload(); };

  window.hoverStar = (n) => { if(rating === 0) paintStars(n); };
  window.resetStar = () => { paintStars(rating); };
  window.handleStar = (n) => {
    if(!user) return alert("Login First!");
    rating = n;
    localStorage.setItem("tc_rate_" + location.pathname, n);
    paintStars(n);
    postToGS("__RATING_ONLY__", "0", n);
  };

  function paintStars(n) {
    document.querySelectorAll(".tc-s").forEach((s, i) => s.classList.toggle("active", i < n));
  }

  window.submitComment = async (pid) => {
    const id = pid === '0' ? 'tc-input' : `reply-input-${pid}`;
    const el = document.getElementById(id);
    const val = el.value.trim();
    if(!val) return;
    
    await postToGS(val, pid, rating);
    el.value = "";
    if(pid !== '0') document.getElementById(`editor-${pid}`).remove();
    setTimeout(sync, 1000);
  };

  async function postToGS(msg, pid, r) {
    await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ url: location.pathname, name: user.n, email: user.e, pic: user.p, comment: msg, parentId: pid, rating: r }),
      mode: "no-cors"
    });
  }

  async function sync() {
    try {
      const res = await fetch(`${SCRIPT_URL}?url=${location.pathname}`);
      const data = await res.json();
      
      document.getElementById("tc-avg-display").innerText = `‚≠ê ${data.avgRating} (${data.totalVotes} votes)`;
      document.getElementById("tc-count").innerText = data.comments.length;

      // Notification Logic
      if(data.comments.length > lastDataCount && lastDataCount !== 0) {
        const latest = data.comments[data.comments.length - 1];
        // Admin check is now handled via GS data (isAdmin boolean)
        if(user && (latest.isAdmin || latest.parentId !== "0")) {
          new Notification("TyagiCore: New Message", { body: latest.comment, icon: latest.pic });
        }
      }
      lastDataCount = data.comments.length;
      render(data.comments);
    } catch(e) {}
  }

  function render(list) {
    const feed = document.getElementById("tc-feed");
    const mains = list.filter(c => c.parentId == "0").reverse();
    let html = "";
    mains.forEach(m => {
      html += renderCard(m, false);
      list.filter(r => r.parentId == m.rowId).forEach(rep => html += renderCard(rep, true));
    });
    feed.innerHTML = html || "<p style='padding:20px;text-align:center'>No comments yet.</p>";
  }

  function renderCard(c, isRep) {
    const adminTag = c.isAdmin ? '<span style="background:#1a73e8;color:#fff;font-size:9px;padding:2px 5px;border-radius:3px;margin-left:5px">ADMIN</span>' : '';
    const canDel = user && (c.isAdmin || user.n === c.name);
    
    return `
      <div class="tc-card ${isRep ? 'reply' : ''}" id="card-${c.rowId}">
        <div class="tc-meta">
          <img src="${c.pic}" style="width:35px;height:35px;border-radius:50%">
          <span>${c.name}${adminTag}</span>
          <span style="color:#f4b400;font-size:11px">${"‚òÖ".repeat(c.userRating)}</span>
        </div>
        <div class="tc-body">${c.comment}</div>
        <div class="tc-actions">
          <span class="tc-btn" onclick="openReply('${c.rowId}', '${c.name}')">Reply</span>
          ${canDel ? `<span class="tc-btn tc-del" onclick="deleteComment('${c.rowId}')">Delete</span>` : ''}
          <span style="color:#999;font-weight:normal">${c.date}</span>
        </div>
        <div id="inline-${c.rowId}"></div>
      </div>`;
  }

  window.openReply = (id, name) => {
    if(!user) return alert("Login First!");
    const box = document.getElementById(`inline-${id}`);
    if(document.getElementById(`editor-${id}`)) return; 
    box.innerHTML = `
      <div class="tc-inline-editor" id="editor-${id}">
        <textarea id="reply-input-${id}" placeholder="Reply to ${name}..."></textarea>
        <div style="display:flex;gap:10px">
          <button onclick="submitComment('${id}')" class="tc-post-btn">Reply</button>
          <button onclick="this.parentElement.parentElement.remove()" style="background:#eee;color:#333" class="tc-post-btn">Cancel</button>
        </div>
      </div>`;
  };

  window.deleteComment = async (id) => {
    if(!confirm("Delete this?")) return;
    await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", rowId: id, userEmail: user.e }), mode: "no-cors" });
    setTimeout(sync, 1000);
  };

  init();
})();
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
