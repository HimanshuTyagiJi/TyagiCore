<script type="application/ld+json" id="tc-seo-schema"></script>

<div id="tyagi-feedback-system" class="tc-container">
    <div class="tc-header">
        <div class="tc-header-left">
            <h2>Community Reviews</h2>
            <div id="rating-summary" class="tc-avg">‚≠ê Loading...</div>
        </div>
        <div class="tc-privacy">üîí Identity Encrypted</div>
    </div>

    <div id="rating-widget" class="tc-rating-box">
        <p>Tap to rate your experience</p>
        <div id="star-row" class="tc-stars">
            <span onclick="handleStarClick(1)" onmouseover="hoverStars(1)" onmouseout="resetStars()">‚òÖ</span>
            <span onclick="handleStarClick(2)" onmouseover="hoverStars(2)" onmouseout="resetStars()">‚òÖ</span>
            <span onclick="handleStarClick(3)" onmouseover="hoverStars(3)" onmouseout="resetStars()">‚òÖ</span>
            <span onclick="handleStarClick(4)" onmouseover="hoverStars(4)" onmouseout="resetStars()">‚òÖ</span>
            <span onclick="handleStarClick(5)" onmouseover="hoverStars(5)" onmouseout="resetStars()">‚òÖ</span>
        </div>
        <p id="rating-msg" class="tc-status-msg"></p>
    </div>

    <div id="login-panel" class="tc-auth">
        <p>Login with Google to post comments</p>
        <div id="g_id_onload" 
             data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com" 
             data-callback="onGoogleAuth"></div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div id="editor-panel" style="display:none;" class="tc-editor">
        <div class="tc-user-bar">
            <img id="user-pfp" src="" alt="Profile">
            <div>
                <strong id="user-name"></strong>
                <small>Verified TyagiCore User</small>
            </div>
            <button onclick="logout()" class="tc-logout-btn">Sign Out</button>
        </div>
        <form onsubmit="submitComment(event)">
            <input type="hidden" id="reply-to" value="0">
            <textarea id="comment-input" placeholder="Share your thoughts..." required></textarea>
            <div id="reply-banner" style="display:none" class="tc-reply-banner">
                Replying... <span onclick="cancelReply()">Cancel</span>
            </div>
            <button type="submit" id="post-btn" class="tc-submit-btn">Post Comment</button>
        </form>
    </div>

    <div id="feed-container" class="tc-feed">
        <div class="tc-loading">üîÑ Syncing discussion...</div>
    </div>
</div>

<style>
/* CSS: Dark/Light Mode Compatible */
.tc-container { max-width: 800px; margin: 20px auto; background: var(--bg-card, #fff); padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); font-family: sans-serif; }
.tc-header { display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 15px; }
.tc-avg { color: #f4b400; font-weight: bold; font-size: 1.2rem; }
.tc-privacy { font-size: 12px; color: #137333; background: #e6f4ea; padding: 5px 12px; border-radius: 20px; height: fit-content; }
.tc-rating-box { text-align: center; background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e8eaed; }
.tc-stars { font-size: 35px; color: #dadce0; cursor: pointer; }
.tc-auth { padding: 40px; border: 2px dashed #dadce0; border-radius: 12px; text-align: center; }
.tc-editor { border: 1px solid #dadce0; padding: 20px; border-radius: 12px; }
.tc-user-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
#user-pfp { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #1a73e8; }
#comment-input { width: 100%; height: 100px; border-radius: 8px; border: 1px solid #dadce0; padding: 12px; resize: none; outline: none; box-sizing: border-box; }
.tc-submit-btn { background: #1a73e8; color: #fff; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
.tc-card { padding: 15px; border-bottom: 1px solid #f1f3f4; transition: background 0.3s; }
.tc-card.reply { margin-left: 45px; border-left: 3px solid #f1f3f4; background: #fafafa; }
.tc-admin { background: #1a73e8; color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 5px; }
.tc-del { color: #d93025 !important; font-weight: bold; }
.tc-status-msg { font-size: 13px; color: #1a73e8; }
</style>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzeeUBWEaqml-WGhVy4eqSyhrSYjhknaClxxPvs3apOd6ktPLVUPoH39XEyMQKyD1Or/exec";
const ADMIN_EMAIL = "officialhimanshutyagi@gmail.com";
let currentUser = JSON.parse(localStorage.getItem("app_user")) || null;
let selectedRating = 0;
let lastSyncCount = 0;

// Initialize
window.onload = () => {
    if(currentUser) showEditor();
    const prevRate = localStorage.getItem("rate_" + window.location.pathname);
    if(prevRate) { selectedRating = prevRate; applyStarLock(prevRate); }
    sync();
    setInterval(sync, 1500); // 1.5s fast sync
    if ("Notification" in window) Notification.requestPermission();
};

function onGoogleAuth(res) {
    const data = JSON.parse(atob(res.credential.split('.')[1]));
    currentUser = { n: data.name, e: data.email, p: data.picture };
    localStorage.setItem("app_user", JSON.stringify(currentUser));
    showEditor();
    sync();
}

function showEditor() {
    document.getElementById("login-panel").style.display = "none";
    document.getElementById("editor-panel").style.display = "block";
    document.getElementById("user-name").innerText = currentUser.n;
    document.getElementById("user-pfp").src = currentUser.p;
}

function logout() { localStorage.removeItem("app_user"); location.reload(); }

// Rating Logic
function hoverStars(n) { updateStarsUI(n, "#f4b400"); }
function resetStars() { updateStarsUI(selectedRating, "#f4b400"); }
function applyStarLock(n) { 
    updateStarsUI(n, "#f4b400"); 
    document.getElementById("rating-msg").innerText = "You rated this " + n + " stars (Play Store Mode)"; 
}
function updateStarsUI(n, color) {
    const s = document.querySelectorAll("#star-row span");
    s.forEach((el, i) => el.style.color = i < n ? color : "#dadce0");
}

function handleStarClick(n) {
    if(!currentUser) return alert("Please login to rate!");
    selectedRating = n;
    localStorage.setItem("rate_" + window.location.pathname, n);
    applyStarLock(n);
    submitComment(null, true);
}

// Submission
async function submitComment(e, isRateOnly = false) {
    if(e) e.preventDefault();
    const btn = document.getElementById("post-btn");
    const txt = isRateOnly ? "Gave a rating" : document.getElementById("comment-input").value;
    
    btn.disabled = true;
    const payload = {
        url: window.location.pathname,
        name: currentUser.n,
        email: currentUser.e,
        comment: txt,
        parentId: document.getElementById("reply-to").value || "0",
        pic: currentUser.p,
        rating: selectedRating
    };

    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
    if(!isRateOnly) { document.getElementById("comment-input").value = ""; cancelReply(); }
    setTimeout(sync, 1000);
    btn.disabled = false;
}

// Sync & Render
async function sync() {
    try {
        const res = await fetch(`${SCRIPT_URL}?url=${window.location.pathname}`);
        const data = await res.json();
        
        // Notifications (Live only)
        if(data.comments.length > lastSyncCount && lastSyncCount !== 0) {
            const newest = data.comments[data.comments.length - 1];
            if (Notification.permission === "granted") {
                new Notification(`TyagiCore: ${newest.name}`, { body: newest.comment, icon: newest.pic });
            }
        }
        lastSyncCount = data.comments.length;

        // SEO & Summary
        document.getElementById("rating-summary").innerText = `‚≠ê ${data.avgRating}/5 (${data.totalVotes} reviews)`;
        updateSEOSchema(data.avgRating, data.totalVotes);

        const box = document.getElementById("feed-container");
        box.innerHTML = "";
        
        const mains = data.comments.filter(c => c.parentId == "0").reverse();
        mains.forEach(m => {
            box.innerHTML += renderCard(m, false);
            data.comments.filter(r => r.parentId == m.rowId).forEach(rep => {
                box.innerHTML += renderCard(rep, true);
            });
        });
    } catch(e) { console.log("Sync..."); }
}

function renderCard(c, isRep) {
    // Privacy: uMail contains only "admin" or "verified" for front-end safety
    // True Email comparison happens on the backend during deletion
    const isAdmin = c.isAdmin;
    const canDelete = currentUser && (currentUser.e === ADMIN_EMAIL || (currentUser.n === c.name && !isRep));
    const starStr = "‚òÖ".repeat(c.rating);

    return `
        <div class="tc-card ${isRep ? 'reply' : ''}">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="${c.pic}" style="width:32px; height:32px; border-radius:50%;">
                <strong>${c.name} ${isAdmin ? '<span class="tc-admin">Admin</span>' : ''}</strong>
                <span style="color:#f4b400; font-size:12px;">${starStr}</span>
            </div>
            <p style="margin:8px 0 8px 42px; color:#333;">${c.comment}</p>
            <div style="margin-left:42px; display:flex; gap:15px; font-size:12px;">
                <button onclick="triggerReply('${c.rowId}')" style="background:none; border:none; color:#1a73e8; cursor:pointer;">Reply</button>
                ${canDelete ? `<button onclick="deleteMsg('${c.rowId}')" class="tc-del" style="background:none; border:none; cursor:pointer;">Delete</button>` : ""}
                <span style="color:#999;">${c.date}</span>
            </div>
        </div>
    `;
}

function updateSEOSchema(avg, count) {
    const schema = {
        "@context": "https://schema.org/",
        "@type": "Product",
        "name": document.title,
        "aggregateRating": { "@type": "AggregateRating", "ratingValue": avg, "ratingCount": count }
    };
    document.getElementById("tc-seo-schema").innerHTML = JSON.stringify(schema);
}

function triggerReply(id) { 
    if(!currentUser) return alert("Login to reply!");
    document.getElementById("reply-to").value = id; 
    document.getElementById("reply-banner").style.display = "block";
    document.getElementById("comment-input").focus(); 
}
function cancelReply() { document.getElementById("reply-to").value = "0"; document.getElementById("reply-banner").style.display = "none"; }

async function deleteMsg(id) {
    if(!confirm("Bhai, delete kar du? Chain-replies bhi ud jayenge.")) return;
    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:"delete", rowId:id, userEmail:currentUser.e}), mode: 'no-cors' });
    setTimeout(sync, 1000);
}
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
