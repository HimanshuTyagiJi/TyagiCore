<div id="tc-root">
  <div class="tc-main-header">
    <div class="tc-branding">
      <h2 class="tc-title">Reviews</h2>
      <div id="tc-avg-display" class="tc-avg">⭐ Loading...</div>
    </div>
  </div>

  <div class="tc-rating-card">
    <div id="tc-star-row" class="tc-stars">
      <span class="tc-s" data-v="1" onclick="handleStar(1)">★</span>
      <span class="tc-s" data-v="2" onclick="handleStar(2)">★</span>
      <span class="tc-s" data-v="3" onclick="handleStar(3)">★</span>
      <span class="tc-s" data-v="4" onclick="handleStar(4)">★</span>
      <span class="tc-s" data-v="5" onclick="handleStar(5)">★</span>
    </div>
  </div>

  <div id="tc-auth-gate" class="tc-auth-gate">
    <div id="g_id_onload" data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com" data-callback="onGoogleAuth"></div>
    <div class="g_id_signin" data-type="standard" data-shape="pill"></div>
  </div>

  <div id="tc-main-editor" class="tc-editor" style="display:none">
    <div class="tc-u-info"><img id="tc-user-pfp" src="" class="tc-pfp"> <span id="tc-user-name"></span></div>
    <textarea id="tc-input" placeholder="Write a comment..."></textarea>
    <button onclick="handleAction('0')" class="tc-post-btn">Post Comment</button>
  </div>

  <div id="tc-feed" class="tc-feed"></div>
</div>

<style>
  #tc-root { max-width: 800px; margin: auto; font-family: sans-serif; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
  .tc-main-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
  .tc-avg { color: #f4b400; font-weight: bold; }
  .tc-stars { font-size: 28px; color: #ddd; cursor: pointer; text-align: center; padding: 10px; }
  .tc-s.active { color: #f4b400; }
  .tc-editor { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; }
  textarea { width: 100%; height: 60px; margin-top: 10px; padding: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
  .tc-post-btn { background: #1a73e8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 5px; }
  .tc-card { padding: 15px; border-bottom: 1px solid #eee; transition: opacity 0.3s; }
  .tc-card.pending { opacity: 0.6; }
  .tc-card.reply { margin-left: 40px; background: #fafafa; border-left: 2px solid #ddd; }
  .tc-pfp { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 10px; }
  .tc-actions { font-size: 12px; color: #1a73e8; cursor: pointer; margin-top: 5px; display: inline-block; }
  .tc-inline-editor { margin-top: 10px; margin-left: 40px; }
</style>

<script>
(function() {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnb3XRauRWpX6K8p--dPwmYZ3_Tpy_705mE6ojp68USXrYfydAlWtjluGDqqJ88ZcP/exec";
  let user = JSON.parse(localStorage.getItem("tc_user")) || null;
  let serverComments = [];
  let pendingComments = [];
  let lastCount = 0;

  window.onGoogleAuth = (res) => {
    const p = JSON.parse(atob(res.credential.split('.')[1]));
    user = { n: p.name, e: p.email, p: p.picture };
    localStorage.setItem("tc_user", JSON.stringify(user));
    location.reload();
  };

  function init() {
    if(user) {
      document.getElementById("tc-auth-gate").style.display = "none";
      document.getElementById("tc-main-editor").style.display = "block";
      document.getElementById("tc-user-name").innerText = user.n;
      document.getElementById("tc-user-pfp").src = user.p;
    }
    sync();
    setInterval(sync, 4000);
  }

  window.handleAction = async (pid) => {
    const input = pid === '0' ? document.getElementById("tc-input") : document.getElementById(`reply-in-${pid}`);
    const msg = input.value.trim();
    if(!msg || !user) return;

    // 1. Instant Local Update (Optimistic UI)
    const tempId = "temp_" + Date.now();
    const localObj = { rowId: tempId, name: user.n, comment: msg, parentId: pid, pic: user.p, date: "Just now...", pending: true, userRating: 0 };
    pendingComments.push(localObj);
    renderAll();
    input.value = "";
    if(pid !== '0') document.getElementById(`inline-${pid}`).innerHTML = "";

    // 2. Background Sync (Navigator Beacon if available for safety on back button)
    const payload = JSON.stringify({ url: location.pathname, name: user.n, email: user.e, pic: user.p, comment: msg, parentId: pid });
    
    try {
      await fetch(SCRIPT_URL, { method: "POST", body: payload, mode: "no-cors" });
    } catch(e) {}
  };

  async function sync() {
    try {
      const res = await fetch(`${SCRIPT_URL}?url=${location.pathname}`);
      const data = await res.json();
      serverComments = data.comments;
      
      // Clean up pending
      pendingComments = pendingComments.filter(p => !serverComments.some(s => s.comment === p.comment && s.name === p.name));
      
      // Notification
      if(serverComments.length > lastCount && lastCount !== 0) {
        const NewC = serverComments[serverComments.length-1];
        if(NewC.isAdmin || NewC.parentId !== "0") {
          new Notification("TyagiCore: " + NewC.name, { body: NewC.comment, icon: NewC.pic });
        }
      }
      lastCount = serverComments.length;
      
      document.getElementById("tc-avg-display").innerText = `⭐ ${data.avgRating} (${data.totalVotes})`;
      renderAll();
    } catch(e) {}
  }

  function renderAll() {
    const feed = document.getElementById("tc-feed");
    const combined = [...serverComments, ...pendingComments];
    const mains = combined.filter(c => c.parentId == "0").reverse();
    
    feed.innerHTML = mains.map(m => `
      <div class="tc-card ${m.pending ? 'pending' : ''}">
        <img src="${m.pic}" class="tc-pfp"> <b>${m.name}</b> <small>${m.date}</small>
        <div>${m.comment}</div>
        <span class="tc-actions" onclick="openReply('${m.rowId}')">Reply</span>
        <div id="inline-${m.rowId}"></div>
        ${combined.filter(r => r.parentId == m.rowId).map(rep => `
          <div class="tc-card reply ${rep.pending ? 'pending' : ''}">
            <img src="${rep.pic}" class="tc-pfp"> <b>${rep.name}</b>
            <div>${rep.comment}</div>
            <span class="tc-actions" onclick="openReply('${m.rowId}')">Reply</span>
          </div>
        `).join('')}
      </div>
    `).join('');
  }

  window.openReply = (id) => {
    document.getElementById(`inline-${id}`).innerHTML = `
      <div class="tc-inline-editor">
        <textarea id="reply-in-${id}" placeholder="Write a reply..."></textarea>
        <button onclick="handleAction('${id}')" class="tc-post-btn">Send Reply</button>
      </div>`;
  };

  init();
})();
</script>
