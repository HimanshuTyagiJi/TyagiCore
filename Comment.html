<div id="comment-system-final" style="max-width:800px; margin:20px auto; font-family:'Segoe UI', Tahoma, sans-serif; background:#ffffff; padding:25px; border-radius:15px; box-shadow:0 8px 30px rgba(0,0,0,0.12);">
    
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f3f4; padding-bottom:15px; margin-bottom:20px;">
        <h2 style="margin:0; color:#1a73e8; font-size:24px;">Comments </h2>
        <span style="font-size:12px; color:#188038; background:#e6f4ea; padding:6px 12px; border-radius:20px; font-weight:500;">ðŸ”’ Privacy Encrypted</span>
    </div>

    <div id="auth-box" style="text-align:center; padding:40px; border:2px dashed #dadce0; border-radius:12px; background:#fafafa;">
        <p style="margin-bottom:20px; color:#5f6368; font-weight:500;">Log in with Google to rate and join the discussion.</p>
        <div id="g_id_onload"
             data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com"
             data-callback="onUserLogin">
        </div>
        <div class="g_id_signin" data-type="standard" data-shape="rectangular"></div>
    </div>

    <div id="editor-box" style="display:none; background:#f8f9fa; padding:20px; border-radius:12px; border:1px solid #e8eaed;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
            <img id="u-avatar" src="" style="width:45px; height:45px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <div style="flex-grow:1;">
                <strong id="u-display-name" style="display:block; color:#202124; font-size:16px;"></strong>
                <small style="color:#70757a;">Your email is private & only visible to site owner.</small>
            </div>
            <button onclick="userLogout()" style="background:#f1f3f4; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:12px; color:#d93025;">Logout</button>
        </div>

        <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
            <span style="font-size:14px; font-weight:bold; color:#3c4043;">Rate us:</span>
            <div id="stars" style="font-size:24px; color:#dadce0; cursor:pointer;">
                <span onclick="rate(1)">â˜…</span><span onclick="rate(2)">â˜…</span><span onclick="rate(3)">â˜…</span><span onclick="rate(4)">â˜…</span><span onclick="rate(5)">â˜…</span>
            </div>
        </div>

        <form onsubmit="sendComment(event)">
            <input type="hidden" id="parent-id" value="0">
            <textarea id="msg-input" placeholder="Join the conversation..." required style="width:100%; height:110px; padding:15px; border:1px solid #dadce0; border-radius:8px; font-size:15px; outline:none; transition:border 0.3s;" onfocus="this.style.borderColor='#1a73e8'"></textarea>
            <div id="reply-info" style="display:none; background:#e8f0fe; color:#1967d2; padding:8px 12px; border-radius:5px; margin-top:8px; font-size:13px;">
                Replying to thread... <span onclick="cancelReply()" style="float:right; cursor:pointer; font-weight:bold; color:#d93025;">Cancel</span>
            </div>
            <button type="submit" id="submit-btn" style="margin-top:12px; padding:12px 30px; background:#1a73e8; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:15px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">Post Comment</button>
        </form>
    </div>

    <div id="comments-container" style="margin-top:35px; border-top:1px solid #f1f3f4; padding-top:20px;">
        <p style="text-align:center; color:#999;">Loading comments...</p>
    </div>
</div>

<script>
// 1. TERA NEW SCRIPT URL
const API_URL = "https://script.google.com/macros/s/AKfycbz8kh-hBXoJlbhybcTehqmk7mu5olWObUXyjHOJ_lj4wVV_XVOLQTWzyDmHzZiyYyCl/exec";
let userData = null;
let currentRating = 0;

// 2. Persistence & Init
window.onload = () => {
    const saved = localStorage.getItem("site_user");
    if(saved) {
        userData = JSON.parse(saved);
        showEditorUI();
    }
    fetchComments();
    if ("Notification" in window) Notification.requestPermission();
};

function onUserLogin(res) {
    const payload = JSON.parse(atob(res.credential.split('.')[1]));
    userData = { name: payload.name, email: payload.email, pic: payload.picture };
    localStorage.setItem("site_user", JSON.stringify(userData));
    showEditorUI();
    fetchComments(); // Reload to show Delete buttons if Admin
}

function showEditorUI() {
    document.getElementById("auth-box").style.display = "none";
    document.getElementById("editor-box").style.display = "block";
    document.getElementById("u-display-name").innerText = userData.name;
    document.getElementById("u-avatar").src = userData.pic;
}

function userLogout() {
    localStorage.removeItem("site_user");
    location.reload();
}

function rate(n) {
    currentRating = n;
    const s = document.querySelectorAll("#stars span");
    s.forEach((el, i) => el.style.color = i < n ? "#f4b400" : "#dadce0");
}

async function sendComment(e) {
    e.preventDefault();
    const btn = document.getElementById("submit-btn");
    const msg = document.getElementById("msg-input").value;
    const parent = document.getElementById("parent-id").value;

    btn.disabled = true;
    btn.innerText = "Posting...";

    const payload = {
        url: window.location.pathname,
        name: userData.name,
        email: userData.email, // Backend checks this
        comment: msg,
        parentId: parent,
        pic: userData.pic,
        rating: currentRating
    };

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
        document.getElementById("msg-input").value = "";
        cancelReply();
        setTimeout(fetchComments, 1500);
    } catch(err) { alert("Failed to post."); }
    finally { btn.disabled = false; btn.innerText = "Post Comment"; }
}

async function fetchComments() {
    try {
        const res = await fetch(`${API_URL}?url=${window.location.pathname}`);
        const data = await res.json();
        const container = document.getElementById("comments-container");
        container.innerHTML = "";

        if(data.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#bdc3c7;'>No comments yet. Be the first!</p>";
            return;
        }

        const parents = data.filter(c => c.parentId == "0");
        parents.reverse().forEach(p => {
            container.innerHTML += buildCommentUI(p, false, data);
            data.filter(r => r.parentId == p.rowId).forEach(reply => {
                container.innerHTML += buildCommentUI(reply, true, data);
            });
        });
    } catch(e) { console.error(e); }
}

function buildCommentUI(c, isReply, fullData) {
    const margin = isReply ? "margin-left:50px; border-left:2px solid #f1f3f4; background:#fcfcfc;" : "margin-bottom:20px; border:1px solid #f1f3f4;";
    const starStr = "â˜…".repeat(c.rating) + "â˜†".repeat(5 - c.rating);
    
    // Privacy: Only owner of comment or Admin can delete
    // Note: 'c.email' backend se nahi aayega agar tune security lagayi hai, 
    // Isliye hum backend se 'isCanDelete' flag bhejte hain ya phir email match karte hain.
    // Filhaal hum email match kar rahe hain (par screen par display nahi kar rahe).
    const canDelete = userData && (userData.email === "officialhimanshutyagi@gmail.com" || userData.email === c.email);

    return `
        <div style="${margin} padding:15px; border-radius:10px; transition:all 0.2s;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                <img src="${c.pic || 'https://www.gravatar.com/avatar/?d=mp'}" style="width:32px; height:32px; border-radius:50%;">
                <strong style="color:#202124; font-size:14px;">${c.name} ${c.email === "officialhimanshutyagi@gmail.com" ? '<span style="color:#1a73e8; font-size:10px; background:#e8f0fe; padding:2px 6px; border-radius:10px; margin-left:5px;">Admin</span>' : ''}</strong>
                <span style="color:#f4b400; font-size:12px;">${c.rating > 0 ? starStr : ''}</span>
                <small style="color:#9aa0a6; font-size:11px;">${c.date}</small>
            </div>
            <p style="margin:5px 0 10px 42px; color:#3c4043; line-height:1.5; font-size:15px;">${c.comment}</p>
            <div style="margin-left:42px; display:flex; gap:20px;">
                <button onclick="handleReplyTrigger('${c.rowId}')" style="background:none; border:none; color:#1a73e8; font-size:12px; cursor:pointer; font-weight:600;">Reply</button>
                ${canDelete ? `<button onclick="handleDelete('${c.rowId}')" style="background:none; border:none; color:#d93025; font-size:12px; cursor:pointer; font-weight:600;">Delete</button>` : ""}
            </div>
        </div>
    `;
}

function handleReplyTrigger(id) {
    if(!userData) { alert("Please login to reply!"); window.scrollTo(0, document.getElementById('auth-box').offsetTop - 50); return; }
    document.getElementById("parent-id").value = id;
    document.getElementById("reply-info").style.display = "block";
    document.getElementById("msg-input").focus();
}

function cancelReply() {
    document.getElementById("parent-id").value = "0";
    document.getElementById("reply-info").style.display = "none";
}

async function handleDelete(id) {
    if(!confirm("Are you sure you want to delete this comment?")) return;
    const payload = { action: "delete", rowId: id, userEmail: userData.email };
    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
    setTimeout(fetchComments, 1000);
}
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
