<div id="tc-root">
  <div class="tc-header">
    <div class="tc-header-left">
      <h2 style="margin:0; font-size:18px;">Discussion & Reviews</h2>
      <div id="tc-rating-summary" class="tc-ps-rating">
        <span id="tc-avg-num" class="tc-avg-big">0.0</span>
        <div class="tc-ps-stars-wrap">
          <div id="tc-avg-stars" class="tc-stars-fs">★★★★★</div>
          <div id="tc-total-votes" class="tc-total-v">0 reviews</div>
        </div>
      </div>
    </div>
    <div id="tc-auth-zone">
      <div id="tc-auth-gate">
        <div id="g_id_onload" data-client_id="307990626713-iajvibefe9hrour51knqkcc5obouuher.apps.googleusercontent.com" data-callback="onGoogleAuth"></div>
        <div class="g_id_signin" data-type="standard" data-shape="pill"></div>
      </div>
      <div id="tc-user-pill" style="display:none" class="tc-user-pill">
        <img id="tc-user-pfp" src="" class="tc-pfp-small">
        <span id="tc-user-name" class="tc-u-name"></span>
        <button onclick="tcLogout()" class="tc-logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <div class="tc-user-rate-box">
    <p style="margin:0 0 5px 0; font-size:12px; color:#666;">Tap stars to rate:</p>
    <div id="tc-star-row" class="tc-stars-input">
      <span class="tc-s" onclick="handleStar(1)" onmouseover="hoverStar(1)" onmouseout="resetStar()">★</span>
      <span class="tc-s" onclick="handleStar(2)" onmouseover="hoverStar(2)" onmouseout="resetStar()">★</span>
      <span class="tc-s" onclick="handleStar(3)" onmouseover="hoverStar(3)" onmouseout="resetStar()">★</span>
      <span class="tc-s" onclick="handleStar(4)" onmouseover="hoverStar(4)" onmouseout="resetStar()">★</span>
      <span class="tc-s" onclick="handleStar(5)" onmouseover="hoverStar(5)" onmouseout="resetStar()">★</span>
    </div>
  </div>

  <div id="tc-main-editor" class="tc-editor-box">
    <textarea id="tc-input" placeholder="Join the discussion..."></textarea>
    <div style="text-align:right; margin-top:8px;">
      <button onclick="handleAction('0')" class="tc-post-btn">Post Comment</button>
    </div>
  </div>

  <div id="tc-feed" class="tc-feed"></div>
</div>

<style>
  #tc-root { max-width: 800px; margin: 20px auto; border: 1px solid #ddd; border-radius: 12px; background: #fff; font-family: sans-serif; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .tc-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; background: #fafafa; }
  .tc-ps-rating { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
  .tc-avg-big { font-size: 32px; font-weight: bold; color: #202124; }
  .tc-ps-stars-wrap { display: flex; flex-direction: column; }
  .tc-stars-fs { color: #f4b400; letter-spacing: 2px; font-size: 14px; }
  .tc-total-v { font-size: 11px; color: #5f6368; }
  .tc-user-pill { display: flex; align-items: center; gap: 8px; background: #fff; border: 1px solid #ddd; padding: 4px 10px; border-radius: 20px; }
  .tc-pfp-small { width: 24px; height: 24px; border-radius: 50%; }
  .tc-u-name { font-size: 12px; font-weight: bold; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tc-logout-btn { border:none; background:none; color:#d93025; font-size:10px; cursor:pointer; font-weight:bold; }
  .tc-user-rate-box { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
  .tc-stars-input { font-size: 28px; color: #ddd; cursor: pointer; }
  .tc-s.active { color: #f4b400; }
  .tc-editor-box { padding: 15px 20px; border-bottom: 1px solid #eee; }
  textarea { width: 100%; height: 70px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: none; box-sizing: border-box; font-family: inherit; font-size: 14px; outline: none; }
  textarea:focus { border-color: #1a73e8; }
  .tc-post-btn { background: #1a73e8; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .tc-card { padding: 15px 20px; border-bottom: 1px solid #f1f1f1; transition: opacity 0.3s; }
  .tc-card.pending { opacity: 0.5; border-left: 3px solid #f4b400; }
  .tc-card.reply { margin-left: 45px; border-left: 2px solid #ddd; background: #fcfcfc; }
  .tc-card-pfp { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 10px; }
  .tc-admin-badge { background: #1a73e8; color: white; font-size: 9px; padding: 2px 5px; border-radius: 3px; margin-left: 5px; font-weight: bold; }
  .tc-actions { margin-left: 42px; margin-top: 10px; display: flex; gap: 15px; font-size: 12px; font-weight: bold; color: #1a73e8; cursor: pointer; }
  .tc-inline-box { margin: 10px 0 0 42px; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyCFIKqQ5OICMZhWPtZqmgem0bEW7QpoPcw",
  authDomain: "appcomment.firebaseapp.com",
  projectId: "appcomment",
  storageBucket: "appcomment.firebasestorage.app",
  messagingSenderId: "156258808941",
  appId: "1:156258808941:web:04a1f7470ac43657c7fb64"
};

const VAPID_KEY = "BPSPa7nCW1nGok9peZQepk25VC1OxeFxFHtWVZsen2TnwVCya3Sq2Dtb4W0sX8u06fRsg-eAqgxEUoW2XP1Oyvo";

  
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBr5OWdBOjHiEy5y2rMoNg73o2nK1jxe7f89j2qX8e8Y72FpDL2HifuDuwCRfE8DxIeA/exec";
const SCRIPT_URL_NOTIF = "https://script.google.com/macros/s/AKfycbxBr5OWdBOjHiEy5y2rMoNg73o2nK1jxe7f89j2qX8e8Y72FpDL2HifuDuwCRfE8DxIeA/exec";
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window._tcInitFCM = async function() {
  const storedUser = JSON.parse(localStorage.getItem("tc_user"));
  if (!storedUser) return;
  try {
    // Register Service Worker with proper scope for GitHub Pages
    const sw = await navigator.serviceWorker.register('./sw.js', { scope: './' });
    const perm = await Notification.requestPermission();
    if (perm !== "granted") return;

    const token = await getToken(messaging, {
      vapidKey: VAPID_KEY,
      serviceWorkerRegistration: sw
    });

    if (token) {
      fetch(SCRIPT_URL_NOTIF, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "fcm_subscribe",
          fcmToken: token,
          email: storedUser.e,
          name: storedUser.n
        })
      });
      console.log("FCM Subscribed ✅");
    }
  } catch(err) { console.log("FCM Registration Error:", err); }

  onMessage(messaging, (payload) => {
    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: "https://cdn-icons-png.flaticon.com/512/1041/1041916.png"
    });
  });
};
</script>

<script>
(function() {
  // TERA NAYA GOOGLE SCRIPT URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwPLP1pA0eh7Eh5iAbxxAo7Q9OIiFAK1G9VvyS8FDMb198WMc5-eMAIkZBFYQzuaIPog/exec";

  let user = JSON.parse(localStorage.getItem("tc_user")) || null;
  let serverData = [];
  let tempLocal = [];
  let isTyping = false;
  let currentRating = 0;

  function init() {
    if (user) {
      document.getElementById("tc-auth-gate").style.display = "none";
      document.getElementById("tc-user-pill").style.display = "flex";
      document.getElementById("tc-user-name").innerText = user.n;
      document.getElementById("tc-user-pfp").src = user.p;
      // Trigger FCM after Login
      setTimeout(() => { if (window._tcInitFCM) window._tcInitFCM(); }, 1500);
    }
    const saved = localStorage.getItem("tc_rate_" + location.pathname);
    if (saved) { currentRating = parseInt(saved); paintStars(currentRating); }
    sync();
    setInterval(() => { if (!isTyping) sync(); }, 5000);
  }

  window.onGoogleAuth = function(res) {
    const p = JSON.parse(atob(res.credential.split('.')[1]));
    user = { n: p.name, e: p.email, p: p.picture };
    localStorage.setItem("tc_user", JSON.stringify(user));
    location.reload();
  };

  window.tcLogout = function() { localStorage.removeItem("tc_user"); location.reload(); };

  window.hoverStar = (n) => { if (!isTyping && currentRating === 0) paintStars(n); };
  window.resetStar = () => { paintStars(currentRating); };
  window.handleStar = (n) => {
    if (!user) return alert("Login required to rate!");
    currentRating = n;
    localStorage.setItem("tc_rate_" + location.pathname, n);
    paintStars(n);
    fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ url: location.pathname, email: user.e, rating: n, comment: "__RATING_ONLY__" }), mode: "no-cors" });
  };
  function paintStars(n) { document.querySelectorAll(".tc-s").forEach((s, i) => { s.classList.toggle("active", i < n); }); }

  window.handleAction = function(pid, mode, rowId) {
    mode = mode || "new"; rowId = rowId || null;
    if (!user) return alert("Please Login!");
    const inputId = mode === "edit" ? "edit-in-" + rowId : (pid === "0" ? "tc-input" : "reply-in-" + pid);
    const inputEl = document.getElementById(inputId);
    const msg = inputEl.value.trim();
    if (!msg) return;

    if (mode === "new") {
      tempLocal.push({ rowId: "temp_" + Date.now(), name: user.n, comment: msg, parentId: pid, pic: user.p, date: "Saving...", pending: true });
    }
    render();
    inputEl.value = "";
    isTyping = false;
    
    const payload = { url: location.pathname, name: user.n, email: user.e, pic: user.p, comment: msg, parentId: pid, rating: currentRating };
    if (mode === "edit") { payload.action = "edit"; payload.rowId = rowId; }
    
    fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload), mode: "no-cors" });
    setTimeout(sync, 1500);
  };

  async function sync() {
    try {
      const r = await fetch(SCRIPT_URL + "?url=" + location.pathname);
      const data = await r.json();
      serverData = data.comments;
      tempLocal = [];
      updateRatingUI(data.avgRating, data.totalVotes);
      render();
    } catch(e) {}
  }

  function updateRatingUI(avg, total) {
    document.getElementById("tc-avg-num").innerText = avg;
    document.getElementById("tc-total-votes").innerText = total + " reviews";
    var stars = "";
    for (var i = 1; i <= 5; i++) stars += i <= Math.round(avg) ? "★" : "☆";
    document.getElementById("tc-avg-stars").innerText = stars;
  }

  function render() {
    const feed = document.getElementById("tc-feed");
    const combined = serverData.concat(tempLocal);
    const mains = combined.filter(c => c.parentId == "0").reverse();
    feed.innerHTML = mains.map(m => renderCard(m, combined)).join("");
  }

  function renderCard(c, list) {
    const isOwner = user && (user.e === ADMIN_EMAIL || user.e === c.email);
    const starStr = c.userRating > 0 ? '<span style="color:#f4b400;font-size:10px;margin-left:8px;">' + "★".repeat(c.userRating) + '</span>' : "";
    let html = '<div class="tc-card ' + (c.parentId !== "0" ? "reply" : "") + (c.pending ? " pending" : "") + '">'
      + '<div><img src="' + c.pic + '" class="tc-card-pfp">'
      + '<span style="font-weight:bold;font-size:14px;">' + c.name + '</span>'
      + (c.isAdmin ? '<span class="tc-admin-badge">ADMIN ⭐</span>' : '')
      + starStr
      + '<small style="float:right;color:#999;">' + c.date + '</small></div>'
      + '<div style="margin:8px 0 0 42px;font-size:14px;color:#333;" id="body-' + c.rowId + '">' + c.comment + '</div>'
      + '<div class="tc-actions">'
      + '<span onclick="checkAuthAndOpen(\'' + c.rowId + '\',\'reply\')">Reply</span>'
      + (isOwner ? '<span onclick="checkAuthAndOpen(\'' + c.rowId + '\',\'edit\')">Edit</span>' : '')
      + (isOwner ? '<span style="color:#d93025" onclick="deleteMsg(\'' + c.rowId + '\')">Delete</span>' : '')
      + '</div>'
      + '<div id="box-' + c.rowId + '" class="tc-inline-box"></div></div>';
    
    list.filter(r => r.parentId == c.rowId).forEach(r => { html += renderCard(r, list); });
    return html;
  }

  window.checkAuthAndOpen = function(id, type) {
    if (!user) return alert("Login to interact!");
    isTyping = true;
    document.querySelectorAll(".tc-inline-box").forEach(b => b.innerHTML = "");
    const box = document.getElementById("box-" + id);
    if (type === "reply") {
      box.innerHTML = '<textarea id="reply-in-' + id + '" placeholder="Write a reply..."></textarea>'
        + '<div style="text-align:right;margin-top:5px;">'
        + '<button onclick="isTyping=false;this.parentElement.parentElement.innerHTML=\'\'" style="background:none;border:none;cursor:pointer;font-size:12px;margin-right:10px;">Cancel</button>'
        + '<button class="tc-post-btn" onclick="handleAction(\'' + id + '\')">Reply</button></div>';
    } else {
      const old = document.getElementById("body-" + id).innerText;
      box.innerHTML = '<textarea id="edit-in-' + id + '">' + old + '</textarea>'
        + '<div style="text-align:right;margin-top:5px;">'
        + '<button onclick="isTyping=false;this.parentElement.parentElement.innerHTML=\'\'" style="background:none;border:none;cursor:pointer;font-size:12px;margin-right:10px;">Cancel</button>'
        + '<button class="tc-post-btn" onclick="handleAction(\'0\',\'edit\',\'' + id + '\')">Update</button></div>';
    }
  };

  window.deleteMsg = async (id) => {
    if (!confirm("Delete permanently?")) return;
    await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", rowId: id, userEmail: user.e }), mode: "no-cors" });
    sync();
  };

  const ADMIN_EMAIL = "officialhimanshutyagi@gmail.com";
  init();
})();
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
